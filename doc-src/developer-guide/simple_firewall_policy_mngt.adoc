= Multi Vendor Firewall Policy Orchestration
:doctype: book 
:imagesdir: ./resources/
ifdef::env-github,env-browser[:outfilesuffix: .adoc]
:source-highlighter: pygments


This documentation will guide you through the implementation of a simple workflow to block a source IP and a destination port on a Linux based VNF

== Overview

This simple firewall policy management tutorial will show you:

- how to use the Microservices and the Workflows to create a layer of abstraction on top of your managed entities.
- how to call a Microservice from a Workflow
- how to design a simple workflow in Python

The firewall will be implemented by a Linux VNF and we will use link:https://en.wikipedia.org/wiki/Iptables[iptables] to configure the security policies.

NOTE: This tutorial can be implemented with the link:../admin-guide/installation{outfilesuffix}#mini-lab[mini lab] and its Linux based managed entity.

- The user must be able to specify an IP address and a service (network port number) on the workflow end-user UI console
- The user must be able to select a managed entity to configure
- The workflow will use the two parameters IP and port to automatically configure the firewall selected by the user

== Implementation

=== Microservice design

==== Firewall Implementation on Linux

- Based on Linux iptables
- Takes an IP and a port as parameters

===== Iptables

Below are some example of iptable used to perform IP/port based filtering

.Create a rule
[source]
----
sudo iptables -A INPUT -p tcp --dport <PORT TO BLOCK> -s <IP TO BLOCK> -j DROP

sudo iptables -A FORWARD -p tcp --dport <PORT TO BLOCK> -s <IP TO BLOCK> -j DROP
----

.Get the list of rules
[source]
----
iptables -L INPUT -n | grep -v Chain | grep -v target
----
Returns
[source]
----
DROP       tcp  --  92.103.182.20        0.0.0.0/0           tcp dpt:
DROP       tcp  --  92.103.182.20        0.0.0.0/0           tcp dpt:80
[source]
----

===== Implementation steps

These are the steps to follow to build the Microservice. These steps are usually the generic steps to design and develop Microservices with other vendors and services.

- Step 1: Create a new Microservice in the repository.
- Step 2: Implement the CREATE command.
- Step 3: Implement the DELETE command.
- Step 4: Implement the IMPORT command.
- Step 5: Test and check the Linux vFW via the command line interface.

==== Step 1: Create a new microservice

Create a new microservice `simple_firewall` 

image:images/simple_firewall_new_ms.png[width=600px]

NOTE: You can refer to the documentation on link:microservice_editor{outfilesuffix}[microservice editor] to learn how to create a new link:../user-guide/configuration_microservices{outfilesuffix}[microservice].

==== Step 2: Implement the CREATE command

The creation of a filtering rule using iptable can be implemented with the CLI command below:

[source]
----
sudo iptables -A INPUT -p tcp --dport <PORT TO BLOCK> -s <IP TO BLOCK> -j DROP
sudo iptables -A FORWARD -p tcp --dport <PORT TO BLOCK> -s <IP TO BLOCK> -j DROP
----
These commands take 2 parameters, a port and an IP address.

Add a CREATE function to your microservice and copy the implementation below:
[source]
----
sudo iptables -A INPUT -p tcp --dport {$params.dst_port} -s {$params.src_ip} -j DROP
sudo iptables -A FORWARD -p tcp --dport {$params.dst_port} -s {$params.src_ip}  -j DROP
----

image:images/simple_firewall_ms_create_func.png[width=600px]

You need to create the 2 variables `dst_port` and `src_ip` as well as `object_id` which is a mandatory variable.

image:images/simple_firewall_ms_variables.png[width=600px]


At this point the microservice is ready for a first test. 
Use a link:../user-guide/configuration_deployment_settings{outfilesuffix}[deployment setting] to associate it to your link:../user-guide/managed_entities{outfilesuffix}[managed entity]

Save and close, select managed entity and click on the tab "configure", select the microservice simple_firewall and click on "+ Add Row"

image:images/simple_firewall_test_ms.png[width=600px]

Then click "Apply Changes".

Once the configuration has been applied, you can connect to the managed entity CLI and verify that the iptables configuration was pushed as expected.
[source]
----
$ docker-compose exec linux_me bash

[root@linux_me /]# iptables -L INPUT -n
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  192.168.23.45        0.0.0.0/0           tcp dpt:2345 
----

==== Step 3: Implement the DELETE command

The deletion of the iptables INPUT and FORWARD rules is executed with the CLI command below:

[source]
----
sudo iptables -D INPUT -p tcp --dport <PORT TO BLOCK>  -s <IP TO BLOCK>  -j DROP 
sudo iptables -D FORWARD -p tcp --dport <PORT TO BLOCK>  -s <IP TO BLOCK>  -j DROP 
----

This will be written in the Delete command of the microservice as:

[source]
----
sudo iptables -D INPUT -p tcp --dport {$simple_firewall.$object_id.dst_port} -s {$simple_firewall.$object_id.src_ip} -j DROP
sudo iptables -D FORWARD -p tcp --dport {$simple_firewall.$object_id.dst_port} -s {$simple_firewall.$object_id.src_ip} -j DRO
----

****
IMPORTANT: The syntax `{$simple_firewall.$object_id.dst_port}` provides a way to access the Microservice variable values in the MSActivator configuration database. 

The convention is as follow:
----
{$<MICROSERVICE NAME>.$object_id.<VARIABLE NAME>}
----
In our case:

MICROSERVICE NAME => simple_firewall 

VARIABLE NAME => dst_port

MICROSERVICE NAME is the name of the Microservice file without the .xml extension.

.Example
simple_firewall.xml => simple_firewall
****

==== Step 4: Implement the IMPORT command

The role of the IMPORT command is to import the current device configuration into the MSActivator database.

The implementation of the IMPORT is based on a set of regular expressions that build a parser that will extract the values of the Microservice variables.

The IMPORT is made of 3 parts:

- the command to run on the device (for CLI command based device).
- the configuration parser, implemented with a set of regular expressions. Only the Microservice identifier extractor is mandatory.
- a set of optional post-import operations implemented in Smarty language (https://www.smarty.net/).

===== Command to run on the device

To list the iptables rules the CLI command to use is: 

[source]
----
# iptables -L INPUT -n
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  192.168.1.2          0.0.0.0/0           tcp dpt:80 
DROP       tcp  --  192.168.1.4          0.0.0.0/0           tcp dpt:443  
----

We can add some "grep" commands to remove the lines that starts with "Chain" and "target" and therefore ease the parsing of the output.

NOTE: The use of grep here is a straightforward way, specific to this use case, to have a simple and easy to parse output. The same result could also be achieved by adding a parser instruction to ignore the first 2 lines starting with "Chain" and "target".

[source]
----
# iptables --line-numbers -L INPUT -n | grep -v Chain | grep -v num
1    DROP       tcp  --  192.168.1.2          0.0.0.0/0           tcp dpt:80 
2    DROP       tcp  --  192.168.1.4          0.0.0.0/0           tcp dpt:443 
----

===== Identifier extractor

The identifier extracter will parse each line and assign the rule ID to the Microservice variable object_id.

Since the rule contains the other variables on the same line, the identifier extractor will also extract the source IP and the destination port.

The regular expression below will extract the object_id, the src_ip and the dst_port.
----
(?<object_id>\d+)\s+DROP\s+tcp\s+--\s+(?<src_ip>([0-9]{1,3}\.){3}[0-9]{1,3})[^:]+:(?<dst_port>\d+)
----

image:images/simple_firewall_ms_import_func.png[width=600px]

==== Step 5: Test and check the Linux vFW via the command line interface

The microservice is ready to be tested. 

Make sure that you can add and delete a policy rule, that it's reflected on the Linux firewall, and that the parameters are also properly synchronised after a call to CREATE or DELETE.

You can also add some iptables rules manually on the Linux CLI and run a configuration synchronisation to make sure that your manual changes are properly imported.

.Example
Add another IP to block.
----
[root@linux_me /]# sudo iptables -A INPUT -p tcp --dport 2345 -s 192.168.67.98 -j DROP
[root@linux_me /]# sudo iptables -A FORWARD -p tcp --dport 2345 -s 192.168.67.98 -j DROP
[root@linux_me /]# iptables -L INPUT -n
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  192.168.23.45        0.0.0.0/0           tcp dpt:2345 
DROP       tcp  --  192.168.67.98        0.0.0.0/0           tcp dpt:2345 
----

And use "Synchronize with Managed Entity" to import the new rule in the configuration database.

image:images/simple_firewall_ms_import_new_rule.png[width=600px]

=== Workflow design


== Getting the Sources
The source of this tutorial is available on link:https://github.com/openmsa[GitHub].

.Microservice
The Microservice simple_firewall.xml can be downloaded from link:https://github.com/openmsa/Microservices/tree/master/Tutorials/LINUX/Generic/Tutorial2[here]

.Workflow
The Workflow can installed from link:https://github.com/openmsa/Workflows/tree/master/Tutorials/python/Simple_Firewall[here]

.Installing the Microservices and the Workflow
link:https://github.com/openmsa/Workflows/blob/master/Tutorials/python/Simple_Firewall/Readme.adoc[Readme.adoc] is available to help you install the workflow

.PHP
The PHP version of Simple Firewall workflow can also be downloaded from link:https://github.com/openmsa/Workflows/tree/master/Tutorials/php/Simple_Firewall[here].