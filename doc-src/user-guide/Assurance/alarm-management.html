<div class="documentation-content">

<div class="wiki-content" id="main-content">
                           
<h1 id="AlarmManagement-Overview"><span class="">Overview</span></h1>
<p>The alarm management module is based on the detection of events which internal (VNOC), SNMP thresholds, or sylogs sent by the managed devices and collected by the MSActivator. Alarm management is designed to provide email notifications to customers or managers, to send SNMP traps to an external trap server, or trigger predetermined automated processes.</p>
<p>The detection of events relies on rules configured at the super administrator level. Rule management is available for the super administrator (ncroot). The rules are defined globally and can be modified by the SOC team. The SOC team can modify the setting of the notification on a per-event and/or per-customer basis. The rules are executed on a periodic basis (the period frequency can be configured) and alarms are generated whenever a rule matches.</p>
<h1 id="AlarmManagement-RuleManagement"><span class="">Rule Management </span></h1>
<p>Rule management allows the super administrator to build, test and configure some rules.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Customer_Portal_alarmMngt.png" width="800"/></a></p>
<h2 id="AlarmManagement-EventDetails"><span class="">Event Details </span></h2>
<p>The event row can be expanded to display all the event fields as well as some additional fields.</p>
<h3 id="AlarmManagement-Eventfields"><span class="">Event fields </span></h3>
<h4 id="AlarmManagement-Internalevents"><span class="">Internal events </span></h4>
<p>The event below is an internal event (prefixed by VNOC) generated by the MSActivator.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_VNOC_event_detail.png" width="800"/></a></p>
<ul>
    <li>_timestamp: this is the date when the event was actually stored in the MSActivator log indexer.</li>
    <li>_ttl: this is the event Time To Leave in the log indexer cluster. "2w" stands for 2 weeks. This means that after 2 weeks this event will be removed from the system. This value is configurable systemwide and it should be set according to the event and logs retention period required for the MSActivator.</li>
</ul>
<h4 id="AlarmManagement-Syslog"><span class="">Syslog </span></h4>
<p>Alarms can also be triggered based on conditions that match certain syslogs sent by devices.</p>
<p>For example, the event below is triggered by a FortiGate when login attempts fail three times in a row:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_syslog_event_detail.png" width="800"/></a></p>
<h3 id="AlarmManagement-Matchingrules"><span class="">Matching rules </span></h3>
<p>When lots of rules are stored in the system, it is convenient to be able to get the list of the rules that match a specific event. The list of matching rules is available in the "matching rule(s)" tab of the event detail.</p>
<p>In the example below, you can see that the first result of the search for "Header Leakage*" would also be matched by the rule RESERVED.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_matching_rules.png" width="800"/></a></p>
<p>The reason for this is the term "RESERVED" is also found in the first result of the search for "Header Leakage*", which houses the rule "RESERVED".</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_matching_rules_2.png" width="800"/></a></p>
<p></p>
<h2 id="AlarmManagement-RuleBuilder"><span class="">Rule Builder </span></h2>
<p>The rule builder field is a simple textbox that allows the user to type rules based on the MSActivator search engine query syntax.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_ruleBuilder.png" width="800"/></a></p>
<p>The rule is directly executed over the events that are available in the system.</p>
<h3 id="AlarmManagement-Severity"><span class="">Severity </span></h3>
<p>You can select from a list of severities to associate to a rule.</p>
<p>A severity selection is required when building a rule. Selecting a severity will allow, for example, the system to raise an alarm whenever a certain severity is raised, whatever the event is.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" height="173" src="images/Alarm_management_sel_severity.png"/></a></p>
<h3 id="AlarmManagement-ScopeofaRule"><span class="">Scope of a Rule</span></h3>
<p>By default, a rule will apply to all customers on the system, and thus by extension, to every device in the system.</p>
<p>It is possible to create rules on a customer by customer basis. When creating customer specific rules, only one customer can be selected at a time.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_sel_customer.png"/></a></p>
<h3 id="AlarmManagement-RuleCriteria"><span class="">Rule Criteria </span></h3>
<p>Two types of criteria are available for configuration:</p>
<ul>
    <li>the alarm recipient</li>
    <li>the alarm media</li>
</ul>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_rulemngt.png"/></a></p>
<p> The alarm recipient is a list of checkboxes (customer, manager, privileged manager and administrator). It is mandatory to select at least one recipient for the rule. Each recipient is associated to a role as defined by the MSActivator <a class="external-link" href="https://training.ubiqube.com/16.2/wikiTraining/index.php/Lab_Setup_%28Portal%29_Concepts" rel="nofollow" title="Lab Setup (Portal) Concepts">RBAC</a>. This selection determines who will be contacted when an alarm is triggered. An alarm can also be sent to a group of users based on the roles selected by the alarm recipient check-boxes.</p>
<h3 id="AlarmManagement-AutomatedProcessExecution"><span class="">Automated Process Execution </span></h3>
<p>In addition to notifications, the user can configure the execution of a Workflow process when an alarm occurs.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Activate_automated_process_execution.png" width="800"/></a></p>
<p>To do this, select a service and a process using the list shown above.</p>
<p>From the advanced parameter section, select the fields that will be passed as parameters to the process.</p>
<p>The list of fields should match the list of variables that are defined for the process.</p>
<p>For example, the following process variables:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Process_variable_example.png" width="800"/></a></p>
<p>would be listed as:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Process_alarm_variable_example.png" width="800"/></a></p>
<p><strong>Note:</strong> the parameters are used to run an aggregation query over the data index in the Elasticsearch cluster. Therefore it is not recommended to use the date or raw log fields as process parameters, because the value of these fields is different for each log.</p>
<h4 id="AlarmManagement-EventCumulationandCumulationTime">Event Cumulation and Cumulation Time</h4>
<p>When processes need to be executed based on events, there is a possibility to control the event cumulation. This is to avoid cases where lots of events are triggered (some security attack for example) but we don't want the system to execute 1 process per event.</p>
<p>By default the event cumulation (EC) is set to 10: ten events will have to be detected before the process is executed.</p>
<p>The default cumulation time is 15 minutes: the system will wait 15 minutes to trigger the process.</p>
<p>This event cumulation time (ET) defines a sliding window of ET minutes. A workflow is triggered when at least EC events have been detected in the sliding window of ET minutes.Setting 0 to ET means an empty sliding window and no alarm can be found (this of course should be avoided).</p>
<p>The two parameters work together and whichever threshold is reached first will trigger the execution.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/image2019-3-1_15-40-11.png" width="300"/></a></p>
<p>Setting the event cumulation (EC) to 0 means "real-time mode". This leads to:</p>
<ul>
    <li>have the fastest response time,</li>
    <li>ensure that there is one workflow executed for one event matching the detection rule.</li>
</ul>
<p>If EC is different from 0, a filter aggregates in one event the events detected at the same time for the same customer and the same device.</p>
<h3 id="AlarmManagement-RuleCreation"><span class="">Rule Creation </span></h3>
<p>To be applied, the rule must be saved in the system.</p>
<p>For example, in order to get notifications whenever login to the device fails due to an invalid password on a managed device, the rule below can be used and saved with a name (in this case, "LOGIN_FAILED"):</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_save_alarm_login_failed.png" width="800"/></a></p>
<h3 id="AlarmManagement-RuleLoadandUpdate"><span class="">Rule Load and Update </span></h3>
<p>To update an existing rule, the rule should be loaded first.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_load_rule.png"/></a></p>
<p><span style="color: rgb(51,51,51);text-decoration: none;">Then click "save rule".</span></p>
<h3 id="AlarmManagement-RuleDeletion"><span class="">Rule Deletion </span></h3>
<p>To delete a rule, simply click on the red "X" and confirm the action when prompted.</p>
<h3 id="AlarmManagement-RuleApplication"><span class="">Rule Application </span></h3>
<p>A rule is applicable as soon as it is saved in the system.</p>
<p>If a rule has been created to send a email if a match is found, the system will start running the rule and possibly sending emails as soon as the rule is saved.</p>
<p>The MSActivator rule matching process is a rule with a period (in seconds) that can be configured with the configuration tool, accessed using the following path:</p>
<pre>SEC Engine configuration-&gt;Initial Configuration-&gt;check_alert period
</pre>
<p>For more details read the <em>Technical details</em> chapter.</p>
<h1 id="AlarmManagement-AlarmManagement">A<span class="">larm Management </span></h1>
<p>Users can view their alarms from the customer portal or from the customer menu (Monitoring-&gt;Alarm)</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_aggAndDetailsView.png" width="800"/></a></p>
<p>The user can select the time range they wish to display (from the last 10 minutes to the past day). Users can also select the number of events to be displayed in the detailed view. The alarm summary view shows a list of events aggregated by severity, type and subtype. The detail view shows each event with the detail of the event that triggered the alarm.</p>
<h1 id="AlarmManagement-Examples"><span class="">Examples </span></h1>
<h2 id="AlarmManagement-CreateaRuletoSendAlarmforSNMPThresholds"><span class="">C</span><span class="">reate a Rule to Send Alarm for SNMP Thresholds </span></h2>
<p>SNMP thresholds can be configured using monitoring <span style="color: rgb(11,1,23);">profiles.</span> The SNMP threshold events are characterized by the keyword <strong>SNMPTHLD</strong>. The following search should bring back some results, provided that this kind of event has been raised and exists in the event index.</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_SNMP_THRESHOLD_rule.png" width="800"/></a></p>
<h2 id="AlarmManagement-CreateRulestoSendAlarmforConfigurationUpdate"><span class="">C</span><span class="">reate Rules to Send Alarm for Configuration Update </span></h2>
<p>Configuration update events are generated by the MSActivator and look like this:</p>
<pre>%VNOC-&lt;severity level&gt;-UPDATECONF: &lt;message&gt;
</pre>
<p>The following rule should match every configuration update related event, whether it failed or it succeded:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_UPDATECONF_OK.png" width="800"/></a></p>
<p>Or for configurations related to object:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_PUSHCONFIG.png" width="800"/></a></p>
<p> In case of a configuration error, the MSActivator will raise an event %VNOC with a severity level 1 (%VNOC-1-UPDATECONF: &lt;message&gt;)</p>
<p>One possible way to detect PUSHCONFIG events that have failed is to filter the event by severity and only search for severity 1:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_PUSHCONFIG_failed.png" width="800"/></a></p>
<p>Another method to generate an alarm based on configuration failure is:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_UPDATECONF_FAILED.png" width="800"/></a></p>
<p>It is often useful to have multiple rule types for different types of configuration related events.</p>
<p>For example, license related issues can be detected by the rule below:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_UPDATECONF_LICENSE_FAILED.png" width="800"/></a></p>
<h2 id="AlarmManagement-CreateRulestoSendAlarmWhenDeviceGoesDownorUp"><span class="">C</span><span class="">reate Rules to Send Alarm When Device Goes Down or Up </span></h2>
<p>To trigger an alarm when an IPUP or an IPDOWN happens, use the rule below:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_IPUPDOWN.png" width="800"/></a></p>
<h2 id="AlarmManagement-CreateaRuletoDetectSecurityEvents">C<span class="">reate a Rule to Detect Security Events </span></h2>
<p>Use the rule below to detect threat events detected by a UTM:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_type_threat.png" width="800"/></a></p>
<p>This rule can be made more specific to target specific threats. As shown below, you can use it to detect a threat were the destination port is 80:</p>
<p><a class="image-popup-fit-width" href=""><img alt="Image" src="images/Alarm_management_type_threat_port80.png" width="800"/></a></p>
<h3 id="AlarmManagement-VideoTutorial">Video Tutorial</h3>
<p></p>
<div class="embeddedObject conf-macro output-block" data-hasbody="false" data-macro-name="multimedia">
    <img controls="" height="380" src="videos/MSActivator-16.2-Alarm-Management.mp4" width="500">
        
    </img>
</div>
<p></p>
<h1 id="AlarmManagement-Technicaldetails"><span class="">Technical details</span></h1>
<h2 id="AlarmManagement-Configurationvariablesthatmodifythealarmcheckingprocess">Configuration variables that modify the alarm checking process</h2>
<p>There are many MSA components involved in the devices states acquisition that lead to potential alarms.For syslogs the following process shows configuration values for fast alarms detection :</p>
<div class="table-responsive">
<div class="table-wrap">
    <table class="confluenceTable tablesorter tablesorter-default stickyTableHeaders" role="grid" style="padding: 0px;">
        <colgroup>
            <col style="width: 129.0px;"/>
            <col style="width: 91.0px;"/>
            <col style="width: 198.0px;"/>
            <col style="width: 214.0px;"/>
        </colgroup>
        <thead class="tableFloatingHeaderOriginal">
            <tr class="tablesorter-headerRow" role="row">
                <th aria-disabled="false" aria-label=": No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" role="columnheader" scope="col" style="user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner"></div>
                </th>
                <th aria-disabled="false" aria-label=": No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" role="columnheader" scope="col" style="text-align: center; user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner"></div>
                </th>
                <th aria-disabled="false" aria-label="Execution periodicity: No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" role="columnheader" scope="col" style="user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner">
                        <p class="Raw" style="text-align: center;">Execution periodicity</p>
                    </div>
                </th>
                <th aria-disabled="false" aria-label="Configuration variable: No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="3" role="columnheader" scope="col" style="user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner">
                        <p class="Raw" style="text-align: center;">Configuration variable</p>
                    </div>
                </th>
            </tr>
        </thead>
        <thead class="tableFloatingHeader" style="display: none;">
            <tr class="tablesorter-headerRow" role="row">
                <th aria-disabled="false" aria-label=": No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" role="columnheader" scope="col" style="user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner"></div>
                </th>
                <th aria-disabled="false" aria-label=": No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" role="columnheader" scope="col" style="text-align: center; user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner"></div>
                </th>
                <th aria-disabled="false" aria-label="Execution periodicity: No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" role="columnheader" scope="col" style="user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner">
                        <p class="Raw" style="text-align: center;">Execution periodicity</p>
                    </div>
                </th>
                <th aria-disabled="false" aria-label="Configuration variable: No sort applied, activate to apply an ascending sort" aria-sort="none" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="3" role="columnheader" scope="col" style="user-select: none;" tabindex="0" unselectable="on">
                    <div class="tablesorter-header-inner">
                        <p class="Raw" style="text-align: center;">Configuration variable</p>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody aria-live="polite" aria-relevant="all">
            <tr role="row">
                <td class="confluenceTd">
                    <pre class="Raw">Port 514</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <h1 id="AlarmManagement-↓" style="text-align: center;">↓</h1>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <p></p>
                </td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <pre class="Raw">syslogd daemon</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">buffering</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">1 second (default = 60)</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">UBI_SMS_SYSLOG_AGREG_TIME</pre>
                </td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <h1 id="AlarmManagement-↓.1" style="text-align: center;">↓</h1>
                </td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <pre class="Raw">parserd</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre>pollingbuffering</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">1 second1 second (default = 10)</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">sms_parserd.conf : parse-files-lookup-periodUBI_ES_BULK_FILE_AGREGATION_TIME</pre>
                </td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <h1 id="AlarmManagement-↓.2" style="text-align: center;">↓</h1>
                </td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <pre class="Raw">load_logs.php</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">polling *.esdata files</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">1 second</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;">
                    <pre class="Raw">called by parserd, periodicity hard-coded</pre>
                </td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <h1 id="AlarmManagement-↓.3" style="text-align: center;">↓</h1>
                </td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
            </tr>
            <tr role="row">
                <td class="confluenceTd">
                    <pre class="Raw">ElasticSearch</pre>
                </td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
                <td class="confluenceTd" style="text-align: center;"></td>
            </tr>
            <tr role="row">
                <td class="confluenceTd" colspan="1">
                    <h1 id="AlarmManagement-↓.4" style="text-align: center;">↓</h1>
                </td>
                <td class="confluenceTd" colspan="1" style="text-align: center;"></td>
                <td class="confluenceTd" colspan="1"></td>
                <td class="confluenceTd" colspan="1" style="text-align: center;"></td>
            </tr>
            <tr role="row">
                <td class="confluenceTd" colspan="1">
                    <pre class="Raw">check_alert.php</pre>
                </td>
                <td class="confluenceTd" colspan="1" style="text-align: center;">
                    <pre class="Raw">polling</pre>
                </td>
                <td class="confluenceTd" colspan="1">
                    <pre class="Raw">10 seconds (default = 60)</pre>
                </td>
                <td class="confluenceTd" colspan="1" style="text-align: center;">
                    <pre class="Raw">UBI_SMS_CHECK_ALERT_PERIOD</pre>
                </td>
            </tr>
        </tbody>
    </table>
</div>
</div>
<p></p>
<p>In command-line on sec node, the <strong>/opt/configurator/configure --expert</strong> command allows the configuration variables modifications.</p>
<p>The menu options for the following variables:</p>
<ul>
    <li>
        <pre class="Raw">UBI_SMS_SYSLOG_AGREG_TIME =&gt; 4: SEC Engine configuration =&gt; 3: SEC Engine syslog configuration =&gt; 2: File aggregation time for syslogs (in sec)</pre>
    </li>
    <li>
        <pre class="Raw">UBI_ES_BULK_FILE_AGREGATION_TIME =&gt; 11: ElasticSearch configuration =&gt; 3: SEC Engine =&gt; 6: Time to wait before closing the ElasticSearch bulk log files</pre>
    </li>
    <li>
        <pre class="Raw">UBI_SMS_CHECK_ALERT_PERIOD =&gt; 4: SEC Engine configuration =&gt; 1: Initial Configuration =&gt; 31: check_alert period</pre>
    </li>
</ul>

</div>

        </div>